# 🎯 会议室预约系统

> 基于微信小程序的现代会议室预订管理系统，采用Apple iOS设计语言和Context7设计框架

## 📋 项目概述

这是一个完整的会议室预约管理系统，包含前端微信小程序和后端Node.js服务：

- **前端**: 微信小程序 (WXML, WXSS, JavaScript) - Apple iOS设计风格
- **后端**: Node.js + Express + MongoDB
- **部署**: PM2 + Nginx + HTTPS
- **服务器**: 47.122.68.192 (www.cacophonyem.me)

## 🎨 最新更新 - Apple iOS设计系统

### ✅ 已完成的改进

#### 1. API错误修复 (2024-01-XX)
- **问题**: `GET https://www.cacophonyem.me/meeting/api/api/user/bookings 404` 错误
- **原因**: URL路径重复了 `/api` 部分
- **解决方案**: 
  - 修复 `frontend/pages/myBookings/myBookings.js` 中的 `apiBaseUrl`
  - 修复 `frontend/pages/profile/profile.js` 中的 `apiBaseUrl`
  - 将 `apiBaseUrl` 从 `'https://www.cacophonyem.me/meeting/api'` 改为 `'https://www.cacophonyem.me/meeting'`

#### 2. 微信小程序配置文件颜色格式修复
- **问题**: `app.json` 和 `theme.json` 中使用了 `rgba` 格式颜色，微信小程序不支持
- **错误信息**: `["window"]["navigationBarBackgroundColor"]: "rgba(248, 248, 248, 0.8)" is not hexColor`
- **解决方案**:
  - `app.json`: 将 `navigationBarBackgroundColor` 和 `tabBar.backgroundColor` 改为十六进制格式
  - `theme.json`: 将所有 `navBarBackgroundColor` 改为十六进制格式
  - 使用符合iOS设计规范的颜色值

#### 3. URLSearchParams 兼容性问题修复
- **问题**: `ReferenceError: URLSearchParams is not defined` 错误
- **原因**: 微信小程序环境（特别是iOS JavaScriptCore）不支持 `URLSearchParams` API
- **解决方案**:
  - 移除自定义的 `requestAPI` 方法
  - 统一使用 `frontend/utils/request.js` 工具函数
  - 该工具已正确实现手动构建查询字符串的方法
  - 提供更好的错误处理、重试机制和用户认证

#### 4. 完整UI重设计 - Apple iOS设计语言

##### 我的预约页面 (`myBookings`)
- **WXML重构**: 
  - 使用iOS风格导航栏
  - SF Symbols图标系统 (Unicode字符，无图片依赖)
  - 现代卡片布局
  - 清晰的信息层次
- **WXSS重构**: 
  - 完整CSS重写，实现iOS设计系统
  - 毛玻璃效果(backdrop-filter)
  - 适当的阴影和边框
  - 暗模式支持
  - 响应式设计

##### 会议室列表页面 (`roomList`)
- **WXML重构**: 
  - iOS风格导航栏
  - 现代搜索栏
  - 网格布局
  - 浮动管理员按钮
- **WXSS重构**: 
  - 现代卡片设计
  - 网格系统
  - 悬停效果
  - 响应式布局

##### 个人资料页面 (`profile`)
- **WXML重构**: 
  - iOS风格用户资料卡片
  - 统计信息展示
  - 现代列表布局
  - iOS风格弹窗
- **WXSS重构**: 
  - 完整的iOS设计系统
  - 现代卡片和列表样式
  - 统计卡片网格
  - 响应式设计

##### 应用配置更新
- **app.json**: 
  - iOS颜色方案 (#007AFF蓝色, #8E8E93灰色)
  - 标签栏导航配置
  - 暗模式启用
  - 颜色格式修复（hex格式）
- **theme.json**: 
  - 完整的亮/暗主题支持
  - iOS颜色系统
  - 颜色格式修复（hex格式）

#### 5. SVG到PNG图标转换
- **问题**: 项目中使用了多个SVG图标文件，可能存在兼容性问题
- **解决方案**:
  - 将所有SVG图标转换为PNG格式
  - 更新所有代码中的文件引用（.svg → .png）
  - 基于现有的高质量PNG图标创建新图标
  - 删除原始SVG文件，减少项目体积
- **转换的文件**:
  - `frontend/images/icons/` 目录下的所有图标
  - `frontend/images/loading.svg` → `loading.png`
  - `frontend/images/default_room.svg` → `default_room.png`
- **代码更新**:
  - `frontend/pages/roomDetail/roomDetail.wxml`
  - `frontend/pages/roomDetail/roomDetail.js`
  - `frontend/pages/admin/admin.wxml`
  - `frontend/pages/roomList/roomList.js`
  - `backend/createPlaceholderImages.js`
  - `backend/initializeRoomData.js`

#### 6. 个人资料页面UI优化 (2024-01-XX)
- **问题**: 
  - 会议室列表页面有浮动管理按钮，但"我的"页面也有会议室管理，功能重复
  - "我的预约"在底部导航和"我的"页面中重复出现
  - "我的"页面顶部大标题设计不美观，不符合iOS设计规范
  - 个人信息无法编辑
- **解决方案**:
  - 删除会议室列表页面的浮动管理按钮
  - 从"我的"页面移除重复的"我的预约"功能项
  - 重新设计个人资料页面，去掉导航栏大标题
  - 个人信息卡片可点击编辑，支持昵称、姓名、手机号修改
  - 添加头像编辑指示器和交互效果
  - 简化功能列表，添加设置选项
- **设计改进**:
  - 更大的用户头像（90px）和阴影效果
  - 头像右下角编辑指示器
  - 用户名旁边的编辑图标
  - 联系信息直接显示在用户信息卡片中
  - 点击卡片即可编辑个人信息
  - 统计信息显示总预约数和即将到来的预约数

#### 7. 设计特性实现

##### SF Symbols图标系统
- 使用Unicode字符实现SF Symbols
- 无图片依赖，提升性能
- 完美适配iOS设计语言

##### 毛玻璃效果
- 导航栏使用backdrop-filter
- 现代层次感设计
- 符合iOS设计规范

##### 响应式设计
- 多屏幕尺寸适配
- 模块化CSS架构
- 性能优化

##### 暗模式支持
- 完整的亮/暗主题切换
- 系统级暗模式检测
- 所有组件暗模式适配

### 🔧 技术改进

#### 性能优化
- 减少图片依赖（使用SF Symbols Unicode字符）
- 模块化CSS架构
- 优化渲染性能

#### 可访问性改进
- 更好的颜色对比度
- 清晰的视觉层次
- 触摸友好的交互区域

#### 一致性改进
- 统一的设计语言
- 一致的交互模式
- 标准化的组件库

## 📁 项目结构

```
meeting/
├── frontend/                 # 微信小程序前端
│   ├── pages/               # 页面文件
│   │   ├── roomList/       # 会议室列表页 ✅ 已更新为iOS风格
│   │   ├── roomDetail/     # 会议室详情页 📝 待更新
│   │   ├── admin/          # 管理员页面 📝 待更新
│   │   ├── myBookings/     # 我的预约页 ✅ 已更新为iOS风格
│   │   └── profile/        # 个人资料页 ✅ 已更新为iOS风格
│   ├── utils/              # 工具函数
│   ├── images/             # 图片资源
│   ├── app.js              # 应用入口
│   ├── app.json            # 应用配置 ✅ 已更新
│   ├── app.wxss            # 全局样式
│   └── theme.json          # 主题配置 ✅ 已创建
├── backend/                 # Node.js后端
│   ├── controllers/        # 控制器
│   ├── models/             # 数据模型
│   ├── routes/             # 路由配置
│   ├── middleware/         # 中间件
│   ├── utils/              # 工具函数
│   └── server.js           # 服务器入口
└── docs/                   # 项目文档
```

## 🚀 部署说明

### 后端部署流程

```bash
# 1. 提交代码到Git仓库
git add .
git commit -m "feat: 描述具体修改内容"
git push origin main

# 2. 连接服务器
ssh root@47.122.68.192

# 3. 进入项目目录并更新代码
cd /root/meeting-backend
git pull origin main

# 4. 安装新依赖（如果有package.json变化）
npm install

# 5. 重启服务
pm2 restart meeting-backend

# 6. 检查服务状态
pm2 status
pm2 logs meeting-backend --lines 20

# 7. 验证部署
curl https://www.cacophonyem.me/meeting/api/health
```

## 🛠️ 开发环境

### 前端开发
1. 使用微信开发者工具
2. 导入 `frontend` 目录
3. 配置AppID和服务器域名

### 后端开发
1. 安装 Node.js 和 MongoDB
2. 复制 `.env.example` 为 `.env` 并配置
3. 运行 `npm install` 安装依赖
4. 运行 `npm start` 启动服务

## 📋 功能清单

### ✅ 已实现功能
- [x] 用户微信登录认证
- [x] 会议室列表浏览 (iOS风格)
- [x] 会议室详情查看
- [x] 会议室预约功能
- [x] 我的预约管理 (iOS风格)
- [x] 个人资料管理 (iOS风格)
- [x] 管理员会议室管理
- [x] 响应式设计
- [x] 暗模式支持
- [x] API错误修复
- [x] 配置文件颜色格式修复

### 📝 待优化功能
- [ ] 会议室详情页iOS风格更新
- [ ] 管理员页面iOS风格更新
- [ ] 推送通知功能
- [ ] 数据统计和报表
- [ ] 批量预约功能

## 🔧 技术栈

### 前端技术
- **框架**: 微信小程序原生框架
- **设计语言**: Apple iOS设计系统 + Context7
- **图标**: SF Symbols (Unicode字符)
- **样式**: WXSS + CSS3 (backdrop-filter, flexbox, grid)
- **主题**: 亮/暗模式自适应

### 后端技术
- **运行环境**: Node.js 16+
- **Web框架**: Express.js
- **数据库**: MongoDB
- **认证**: JWT + 微信小程序登录
- **部署**: PM2 + Nginx + HTTPS

## 🎨 设计系统

### 颜色规范
- **主色调**: #007AFF (iOS蓝)
- **辅助色**: #8E8E93 (iOS灰)
- **背景色**: #F2F2F7 (浅灰)
- **卡片背景**: #FFFFFF (白色)
- **错误色**: #FF3B30 (iOS红)
- **成功色**: #34C759 (iOS绿)

### 字体规范
- **字体族**: -apple-system, BlinkMacSystemFont, 'SF Pro Display'
- **标题**: 34px/28px (大标题/页面标题)
- **正文**: 17px (主要内容)
- **辅助**: 15px/14px (次要信息)
- **标签**: 12px (徽章、标签)

### 间距规范
- **容器边距**: 16px/20px
- **元素间距**: 8px/12px/16px
- **卡片内边距**: 16px/20px/24px
- **按钮高度**: 44px/32px

## 📞 联系方式

如有问题或建议，请联系开发团队。

---

📱 **让会议室预约变得简单高效** | 🎨 **Apple设计语言** | ⚡ **高性能体验**

## ✅ 系统问题修复记录

### 🐛 问题1：预约提交JavaScript错误 (已修复)
**错误信息**: `TypeError: _this4.data.bookingForm.attendeeCount.trim is not a function`
**解决方案**: 修复了代码中对数字类型调用.trim()方法的错误，现在可以正确处理数字和字符串类型的参会人数
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 👥 问题2：管理员权限设置 (已完成)
**需求**: 设置两个用户为管理员
**解决方案**: 
- 创建了管理员设置脚本 `backend/scripts/setAdmin.js`
- 在数据库中创建了两个管理员用户（test_admin_001 和 test_admin_002）
**状态**: ✅ 已完成，两个管理员用户已设置

### 🐛 问题3：会议室详情页ID缺失错误 (已修复)
**错误信息**: "会议室ID缺失"，无法查看会议室详情
**原因分析**: 前端数据绑定中ID字段可能为空
**解决方案**: 
- 增强了WXML中的数据绑定：`data-room-id="{{item.id || item.roomId || item._id}}"`
- 添加了详细的调试日志，帮助定位数据传递问题
- 支持多种ID字段的备用方案
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 🔧 问题4：微信登录优化和真实用户管理员设置 (已完成)
**问题背景**: 
- 用户使用真实微信登录，但未创建真实的数据库用户记录
- 需要将所有真实用户设置为管理员
**解决方案**: 
- 创建了新的微信认证工具 `frontend/utils/auth.js`
- 重构了app.js和roomList.js的登录逻辑，确保使用正确的微信登录API
- 完善了错误处理和用户体验
- 在数据库中创建了管理员用户（openid: oKj5L5BtQ3aX7vY9ZnM2rP8qW1eF）
- 管理员设置脚本已就绪，可随时将新登录用户设置为管理员
**技术改进**:
- 统一的微信登录流程，支持真实openid获取
- 优雅的错误处理和重试机制
- 临时用户备用方案（网络异常时）
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 🚨 小程序体验版登录问题解决方案

### 问题现象
小程序体验版扫码后出现登录失败

### ✅ 已完成解决方案

#### 1. 服务器状态检查 ✅
- 后端API服务正常运行
- 数据库连接正常
- 微信登录接口已修复并部署

#### 2. HTTPS配置 ✅ **已完成**
- **域名**: `www.cacophonyem.me`
- **API地址**: `https://www.cacophonyem.me/meeting/api/`
- **SSL证书**: 有效期至2025年8月12日
- **API测试**: https://www.cacophonyem.me/meeting/api/health

#### 3. 微信小程序后台配置 🔧 **请立即配置**
**必须在微信公众平台进行以下配置：**

1. **登录微信公众平台**
   - 访问: https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **配置服务器域名**
   - 进入【开发管理】→【开发设置】→【服务器域名】
   - 在 **request合法域名** 中添加: `www.cacophonyem.me`
   - 保存配置

#### 4. 小程序代码更新 ✅
已完成以下修复：
- ✅ 修复微信登录流程，正确调用 `wx.login()` 和后端API
- ✅ 添加完整的错误处理和用户提示
- ✅ 更新API基础URL为HTTPS: `https://www.cacophonyem.me/meeting`
- ✅ 添加用户信息缓存机制

#### 5. 后端API增强 ✅
已添加以下功能：
- ✅ 新增 `/api/user/wechat-login` 接口
- ✅ 支持微信 code 换取 openid
- ✅ 完整的用户注册/登录逻辑
- ✅ 错误处理和日志记录
- ✅ HTTPS支持和反向代理配置

### 🚀 现在您需要做的

#### **第1步：配置微信小程序后台** (最重要!)
1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入【开发管理】→【开发设置】→【服务器域名】
3. 在 **request合法域名** 中添加：`www.cacophonyem.me`
4. 保存配置

#### **第2步：重新编译并上传小程序**
1. 在微信开发者工具中点击【编译】
2. 查看控制台确认无错误
3. 上传体验版
4. 扫码测试登录功能

### 🧪 测试验证

**HTTPS API测试**：
```bash
# 健康检查
curl https://www.cacophonyem.me/meeting/api/health

# 微信登录接口（会返回错误，这是正常的，因为code是测试值）
curl https://www.cacophonyem.me/meeting/api/user/wechat-login \
  -X POST -H "Content-Type: application/json" \
  -d '{"code":"test_code","nickname":"测试用户"}'
```

**小程序测试**：
- 访问 `pages/test/test` 页面进行API连接测试
- 查看控制台日志确认登录流程
- 扫描体验版二维码进行真机测试

### 📊 当前配置总结

- **🌐 域名**: www.cacophonyem.me
- **🔒 协议**: HTTPS (SSL证书有效)
- **📡 API基址**: https://www.cacophonyem.me/meeting/api/
- **🏠 服务器**: 47.122.68.192
- **📱 小程序ID**: wxa4f8f0622653dea5
- **✅ 状态**: 服务器配置完成，等待微信后台域名配置

### ⚠️ 重要提醒

**配置完微信后台域名后，您的小程序体验版就可以正常登录了！**

### 🎯 功能7：全新"我的预约"系统重新设计 (已完成)
**需求背景**: 用户对原有的"我的预约"功能设计不满意，要求重新设计一个更完善的系统
**功能特性**: 
- **底部Tab Bar导航**: 新增"会议室"和"我的"两个主要Tab，让用户更容易找到功能入口
- **全新的"我的"页面**: 包含用户信息展示、功能入口、联系信息管理等
- **现代化卡片设计**: 每条预约记录以独立卡片形式展示，包含所有核心信息
- **智能状态分类**: 自动区分"即将开始的预约"和"历史预约"，实时状态判断
- **详细信息展示**: 会议室图片、名称、位置、预约时间、会议主题、参会人数、联系人信息等
- **完善的交互体验**: 下拉刷新、加载更多、空状态处理、错误处理等

**详细信息包含**:
- 会议室名称和位置标识
- 预约日期（含星期显示，如：2025-06-15 (周六)）
- 预约时间段（如：09:00 - 10:00）
- 会议主题（用户填写的主题内容）
- 参会人数（如果填写了）
- 联系人姓名和电话（脱敏处理）
- 预约状态：已预约、进行中、已完成、已取消
- 会议室第一张图片展示

**技术实现**:
- **前端**: 全新的页面架构，Tab Bar导航，现代化UI设计，Emoji图标系统
- **后端**: 支持分页查询，优化性能，返回详细的预约信息
- **状态管理**: 实时状态判断，智能分类显示
- **用户体验**: 响应式设计，流畅的交互动画，完善的边界情况处理

**边界情况处理**:
- 无预约记录时显示友好提示和引导按钮
- 加载中显示动画效果
- 网络异常时提供重试选项
- 支持大量预约记录的分页加载

**实现时间**: 2025-06-14
**状态**: ✅ 已完成并部署

### 🎨 功能8：Apple iOS设计系统全面重构 (已完成)
**需求背景**: 用户反馈当前UI设计过于复杂，希望采用Apple Design风格，简洁高级的UI设计
**功能特性**: 
- **Apple iOS设计语言**: 采用SF Symbols图标系统，iOS原生设计规范
- **现代化视觉效果**: 毛玻璃效果、渐变背景、圆角设计、微交互动画
- **简洁卡片布局**: 重新设计会议室卡片和预约卡片，信息层次清晰
- **一致的交互体验**: 统一的按钮样式、动画效果、反馈机制
- **响应式设计**: 支持不同屏幕尺寸，优化移动端体验
- **暗黑模式支持**: 完整的深色模式适配，自动跟随系统主题

**设计改进**:
- **导航栏**: iOS风格毛玻璃导航栏，SF Symbols图标
- **搜索栏**: 圆角搜索框，实时搜索反馈
- **卡片设计**: 简洁的白色卡片，清晰的信息层次
- **状态指示**: 彩色圆点状态指示器，直观的可用性显示
- **按钮样式**: iOS原生按钮风格，优雅的触摸反馈
- **字体系统**: SF Pro Display字体，优化的字重和间距

**技术实现**:
- **CSS架构**: 模块化CSS，支持主题切换
- **图标系统**: SF Symbols Unicode字符，无需图片资源
- **动画效果**: CSS3动画，流畅的微交互
- **布局系统**: Flexbox + Grid布局，响应式设计
- **主题系统**: 支持亮色/暗色模式切换

**性能优化**:
- 减少图片依赖，使用字符图标
- 优化CSS加载，减少重绘重排
- 响应式图片加载
- 流畅的60fps动画

**实现时间**: 2025-06-15
**状态**: ✅ 已完成并部署

### 🐛 问题修复：API路径错误 (已修复)
**错误信息**: `GET https://www.cacophonyem.me/meeting/api/api/user/bookings 404 (Not Found)`
**原因分析**: 前端配置中API基础URL包含了`/api`路径，但请求时又添加了`/api`，导致双重路径错误
**解决方案**: 
- 修正了 `frontend/pages/myBookings/myBookings.js` 中的 `apiBaseUrl` 配置
- 修正了 `frontend/pages/profile/profile.js` 中的 `apiBaseUrl` 配置
- 将API基础URL从 `https://www.cacophonyem.me/meeting/api` 改为 `https://www.cacophonyem.me/meeting`
**修复时间**: 2025-06-15
**状态**: ✅ 已修复并验证

### 🧠 功能5：用户联系人信息自动记忆功能 (已完成)
**需求背景**: 用户每次预约都需要重新填写联系人姓名和电话，体验不够友好
**功能特性**: 
- **智能记忆**: 系统自动记住用户首次填写的联系人信息，存储在数据库中
- **自动填入**: 用户下次预约时，联系人信息会自动填入表单，无需重复输入
- **智能更新**: 如果用户修改了联系人信息，系统会自动检测变化并更新数据库记录
- **透明体验**: 整个过程对用户透明，不影响正常的预约流程

**实现细节**:
- **前端**: 页面初始化时自动获取用户历史联系人信息并填入表单
- **后端**: 预约提交时智能检测联系人信息变化并自动更新用户记录
- **数据库**: 利用现有User模型的contactName和contactPhone字段
- **API**: 使用现有的 `/api/user/profile` 和 `/api/user/contact` 接口

**技术实现**:
```javascript
// 前端：自动获取并填入联系人信息
async fetchUserContactInfo() {
    const result = await this.requestAPI('GET', '/api/user/profile');
    if (result.success && result.data.contactName) {
        this.setData({
            'bookingForm.contactName': result.data.contactName,
            'bookingForm.contactPhone': result.data.contactPhone
        });
    }
}

// 后端：智能更新联系人信息
if (user.contactName !== contactName || user.contactPhone !== contactPhone) {
    user.contactName = contactName;
    user.contactPhone = contactPhone;
    await user.save();
}
```

**用户体验优化**:
- ✅ 首次用户正常填写联系人信息
- ✅ 老用户自动填入历史信息，节省时间
- ✅ 信息变更时自动更新，保持同步
- ✅ 完全向后兼容，不影响现有功能

**实现时间**: 2025-06-12
**状态**: ✅ 已完成并部署

### 🔧 问题6：预约时间显示和界面优化 (已修复)
**问题背景**: 
- 预约时间段时，提交预约后的模态框显示的结束时间比用户选择的结束时间多半个小时
- 编辑会议室时设备选择显示了对勾✅图标，用户希望只显示复选框样式

**解决方案**: 
- **时间显示修复**: 修正了`showBookingModal()`和`submitBooking()`函数中的时间计算逻辑
  - 原逻辑：在最后选中时间槽基础上错误地加了30分钟
  - 新逻辑：结束时间就是用户选择的最后一个时间槽的时间，严格与用户选择保持一致
- **界面优化**: 移除了管理员页面设备选择中的对勾图标，现在只显示复选框样式

**技术实现**:
```javascript
// 修正前：错误地加了30分钟
const endMinute = parseInt(endTimeParts[1]) + 30;

// 修正后：直接使用用户选择的时间
const actualEndTime = lastSelectedSlot.time;
```

**用户体验改进**:
- ✅ 预约时间显示现在完全准确，与用户选择严格一致
- ✅ 设备选择界面更简洁，通过背景色和边框体现选中状态
- ✅ 消除了用户对时间显示的困惑

**修复时间**: 2025-06-12
**状态**: ✅ 已修复并部署

### 🔧 问题7：周末预约限制和会议室详情显示问题 (已修复)
**问题背景**: 
- 用户预约周末时间出现400错误："只能预约工作日的会议室"
- 查看会议室详情时显示"未找到会议室信息"

**问题分析**:
- **周末预约问题**: 前端已经移除了工作日限制，但后端API中仍有多处工作日校验逻辑
- **会议室详情问题**: 后端在非工作日时返回特殊响应格式，可能导致前端显示异常

**解决方案**:
- **后端API修复**: 
  - `bookingController.js`: 注释掉`createBooking`和`createManualBooking`中的工作日校验
  - `roomController.js`: 注释掉`getRoomDetail`和`getRoomAvailability`中的工作日限制
  - `getRoomAvailabilityStatus`: 移除工作日状态检查
- **保留工作日标识**: 在响应中保留`isWorkday`字段用于前端显示，但不限制功能
- **添加调试信息**: 增加详细的前后端日志，便于问题排查

**技术实现**:
```javascript
// 修改前：限制性校验
if (!TimeHelper.isWorkday(bookingDate)) {
    return ResponseHelper.error(res, '只能预约工作日的会议室');
}

// 修改后：注释掉限制
// 验证是否为工作日 - 现已开放周末预约
// if (!TimeHelper.isWorkday(bookingDate)) {
//     return ResponseHelper.error(res, '只能预约工作日的会议室');
// }
```

**用户体验改进**:
- ✅ 用户现在可以在周末预约会议室
- ✅ 会议室详情页面在周末也能正常显示
- ✅ 前后端逻辑保持一致
- ✅ 添加了详细的调试日志，便于问题排查

**修复时间**: 2025-06-13
**状态**: ✅ 已修复并部署

## 核心功能

### 用户功能
- 🔐 **用户认证**: 安全的微信小程序登录系统
- 📋 **会议室浏览**: 查看所有可用会议室列表和详细信息
- 📅 **在线预约**: 选择时间段和会议室进行预约
- 🧠 **智能记忆**: 自动记忆用户的联系人信息，下次预约时自动填入
- 📱 **预约管理**: 查看、修改、取消个人预约记录
- 🔍 **实时查询**: 实时查看会议室占用状态

### 管理员功能
- 🏢 **会议室管理**: 添加、编辑、删除会议室信息
- 👥 **用户管理**: 管理系统用户权限
- 📊 **数据统计**: 查看预约统计和使用情况
- ⚙️ **系统设置**: 配置系统参数和规则

## 技术架构

### 前端技术栈
- **框架**: 微信小程序原生开发
- **响应式设计**: 支持不同手机屏幕尺寸
- **交互体验**: 直观的用户界面和流畅的操作体验

### 后端技术栈
- **框架**: Node.js + Express
- **数据库**: MongoDB
- **部署**: PM2 + Nginx
- **API设计**: RESTful API架构
- **权限控制**: 基于微信openid的用户认证

### 项目结构
```
meeting/
├── frontend/           # 微信小程序前端
│   ├── pages/         # 页面组件
│   │   ├── test/      # 测试页面
│   │   ├── admin/     # 管理员页面
│   │   ├── roomDetail/# 会议室详情页
│   │   └── roomList/  # 会议室列表页
│   ├── images/        # 图片资源
│   └── utils/         # 工具函数
├── backend/           # Node.js后端
│   ├── controllers/   # 控制器
│   ├── middleware/    # 中间件
│   ├── models/        # 数据模型
│   ├── routes/        # 路由配置
│   ├── uploads/       # 文件上传
│   └── utils/         # 工具函数
└── docs/              # 项目文档
```

## 使用指南

### 快速开始

1. **克隆项目**
   ```bash
   git clone [repository-url]
   cd meeting
   ```

2. **启动后端服务**
   ```bash
   cd backend
   npm install
   npm start
   ```

3. **配置微信小程序**
   - 在微信开发者工具中导入 `frontend` 目录
   - 配置小程序AppID: `wxa4f8f0622653dea5`
   - 在微信公众平台配置服务器域名

### 用户操作流程

1. **微信授权登录**: 小程序自动调用微信登录
2. **浏览会议室**: 查看可用会议室列表
3. **选择会议室**: 点击会议室查看详细信息
4. **创建预约**: 选择时间段并提交预约
5. **管理预约**: 在个人中心查看和管理预约

### 管理员操作

1. **系统管理**: 使用管理员账户登录
2. **会议室管理**: 添加/编辑会议室信息
3. **用户管理**: 管理用户权限和状态
4. **数据统计**: 查看系统使用情况

## 设计规范

### UI/UX设计原则
- **简洁直观**: 清晰的页面布局和导航结构
- **响应式设计**: 适配不同设备屏幕尺寸
- **一致性**: 统一的视觉风格和交互模式
- **易用性**: 减少用户操作步骤，提高效率

### 页面设计要求
1. **测试页面**: 系统功能测试和调试
2. **会议室列表**: 卡片式布局展示会议室信息
3. **会议室详情**: 详细信息展示和预约操作
4. **预约表单**: 直观的时间选择和表单提交
5. **个人中心**: 预约记录管理和个人设置
6. **管理后台**: 功能完整的管理界面

## API接口文档

### 用户接口
- `POST /api/user/wechat-login` - 微信小程序登录
- `POST /api/user/login` - 传统登录
- `GET /api/user/profile` - 获取用户信息
- `GET /api/user/role` - 获取用户角色
- `PUT /api/user/contact` - 更新联系信息

### 会议室接口
- `GET /api/rooms` - 获取会议室列表
- `GET /api/rooms/:id` - 获取会议室详情
- `POST /api/bookings` - 创建预约
- `GET /api/bookings/user/:id` - 获取用户预约

### 管理接口
- `POST /api/admin/rooms` - 添加会议室
- `PUT /api/admin/rooms/:id` - 更新会议室
- `DELETE /api/admin/rooms/:id` - 删除会议室
- `GET /api/admin/statistics` - 获取统计数据

### 系统接口
- `GET /api/health` - 健康检查

## 部署信息

### 生产环境
- **服务器**: 47.122.68.192
- **API地址**: http://47.122.68.192
- **小程序AppID**: wxa4f8f0622653dea5
- **数据库**: MongoDB 7.0.21
- **进程管理**: PM2
- **反向代理**: Nginx

### 环境要求
- Node.js 18+
- MongoDB 7.0+
- 微信小程序开发者账号

## 开发计划

### 第一阶段: 基础功能 ✅
- [x] 项目架构设计
- [x] 微信登录系统
- [x] 会议室管理模块
- [x] 基础预约功能

### 第二阶段: 功能增强
- [ ] 预约冲突检测
- [ ] 消息通知功能
- [ ] 数据统计报表
- [ ] HTTPS配置

### 第三阶段: 高级功能
- [ ] 会议室设备管理
- [ ] 重复预约功能
- [ ] 系统集成接口
- [ ] 性能优化

## Figma设计集成

### 设计文件信息
- **文件URL**: https://www.figma.com/design/hXPq60Bfza1mWBmgaZLKq1/Untitled
- **文件ID**: hXPq60Bfza1mWBmgaZLKq1
- **状态**: 连接配置中

### 解决Figma连接问题
1. **权限设置**: 确保Figma文件设置为公开访问
2. **访问令牌**: 在Figma账户设置中生成新的API令牌
3. **文件权限**: 确认对文件有查看权限
4. **网络连接**: 检查网络和防火墙设置

## 贡献指南

1. Fork 项目仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

如有问题或建议，请通过以下方式联系：
- 项目Issues: [GitHub Issues]
- 邮箱: [your-email@example.com]

---

## 🔧 最近修复记录 (2025-06-12)

### ✅ 图片上传功能修复
1. **服务器环境配置**
   - ✅ 创建并配置 `/root/meeting-backend/uploads/rooms/` 目录
   - ✅ 设置正确的目录权限 (755)
   - ✅ 修复 nginx 静态文件路径配置

2. **API接口优化**
   - ✅ 图片上传接口 `/api/upload/room-image` 正常工作
   - ✅ 身份验证中间件支持 `x-user-openid` 请求头
   - ✅ 管理员权限验证正常

3. **前端用户认证优化**
   - ✅ 优化管理员页面用户身份验证流程
   - ✅ 添加用户openid缺失时的重新获取机制
   - ✅ 增强管理员权限检查

4. **系统稳定性改进**
   - ✅ 修复后端服务端口冲突问题
   - ✅ 优化PM2进程管理
   - ✅ 添加详细的错误日志和调试信息

5. **页面跳转问题修复** 🆕
   - ✅ 修复会议室详情页面"未提供会议室ID"错误
   - ✅ 增强参数传递的兼容性（支持roomId、id等多种参数名）
   - ✅ 添加详细的调试日志，便于问题排查
   - ✅ 改进错误提示，显示具体的参数信息

### 🌐 当前系统状态
- **API基础地址**: `https://www.cacophonyem.me/meeting`
- **图片上传**: ✅ 正常工作
- **用户认证**: ✅ 微信登录正常
- **管理员功能**: ✅ 完全可用
- **文件访问**: ✅ 图片可通过 `/meeting/uploads/` 访问

*最后更新: 2025年6月12日 - 修复管理员图片上传功能* 🚀

### 🐛 问题5：会议室列表页面筛选功能和导航栏重叠问题 (已修复)
**问题背景**: 
- 筛选功能无法正常工作，API参数不匹配
- 右上角自定义图标与微信小程序胶囊按钮重叠，影响用户体验
**问题分析**: 
- 前端使用`minCapacity`和`maxCapacity`参数，但后端API期望`capacityMin`和`capacityMax`
- 设备筛选功能不完整，只显示"开发中"提示
- 自定义导航栏没有考虑微信胶囊按钮位置，导致图标重叠
**解决方案**: 
- ✅ 修复API参数名称不匹配：`minCapacity` → `capacityMin`，`maxCapacity` → `capacityMax`
- ✅ 完善设备筛选功能，支持按设备类型筛选会议室
- ✅ 获取微信胶囊按钮位置信息，动态计算安全的导航栏布局
- ✅ 优化导航栏图标布局，避免与系统胶囊按钮重叠
- ✅ 调整搜索筛选区域的吸顶位置，适配动态导航栏高度
**技术改进**:
- 使用`wx.getMenuButtonBoundingClientRect()`获取胶囊按钮精确位置
- 动态计算导航栏安全区域：`(胶囊top - 状态栏高度) * 2 + 胶囊高度`
- 移除管理员图标到底部浮动按钮，减少导航栏拥挤
- 优化筛选选项，支持多种设备类型筛选
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，筛选功能正常，导航栏布局美观无重叠

### 🐛 问题6：小程序启动时出现globalData undefined错误 (已修复)
**问题背景**: 
- 每次打开小程序都会出现 "Cannot read property 'globalData' of undefined" 错误提示
- 错误影响用户体验，可能导致功能异常
**问题分析**: 
- 在小程序启动时，页面的 onLoad 生命周期函数可能比 app.js 的初始化更早执行
- 代码中直接调用 `getApp().globalData` 没有检查 getApp() 是否返回 undefined
- utils/request.js 在模块加载时就尝试获取 globalData，时机过早
**解决方案**: 
- ✅ 在所有页面中添加 `safeGetAppData()` 方法，安全获取App实例
- ✅ 添加 getApp() 的 null 检查和重试机制
- ✅ 修复 utils/request.js 中的初始化时机问题
- ✅ 修复 utils/auth.js 中的 getSafeApp() 安全检查
- ✅ 为所有可能失败的情况提供默认值和容错处理
**技术改进**:
- 使用 try-catch 包装所有 getApp() 调用
- 实现延迟重试机制，等待 App 实例完全初始化
- 提供默认的 API 基址和配置，确保功能不受影响
- 优化错误提示，避免用户看到技术性错误信息
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，小程序启动流程稳定，无 globalData 错误

### 🐛 问题7：管理员页面参会人数总是显示1 (已修复)
**问题背景**: 
- 用户反馈管理员页面的预约记录中参会人数总是显示1，无论实际输入多少
- 影响管理员查看和统计会议室使用情况
**问题分析**: 
- 前端预约表单中存在字段名不一致的问题
- JS文件中初始化使用 `attendeeCount`（单数形式）
- WXML表单绑定使用 `attendeesCount`（复数形式）
- 提交时检查的是 `attendeeCount`，但用户输入绑定在 `attendeesCount`
- 导致用户输入的参会人数无法被正确获取，总是使用默认值1
**解决方案**: 
- ✅ 统一前端字段名：将所有 `attendeeCount` 改为 `attendeesCount`
- ✅ 修复数据初始化中的字段名
- ✅ 修复表单清空方法中的字段名
- ✅ 修复提交逻辑中的字段检查
- ✅ 确保前后端字段名完全一致
**技术改进**:
- 建立统一的字段命名规范，避免单复数混用
- 前端表单字段与后端API字段保持严格一致
- 添加字段名一致性检查机制
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，参会人数能正确显示用户输入的值

## 🔧 最新修复 (2025-06-13)

### 安卓设备登录连接失败问题修复

**问题描述：**
安卓用户在登录时经常遇到"连接失败"的问题，而iOS用户正常。

**根本原因分析：**
1. **存储同步延迟**：安卓设备上`wx.setStorageSync`可能存在延迟，导致登录成功后立即发起的API请求获取不到用户标识
2. **请求头兼容性**：安卓系统对HTTP请求头的处理与iOS略有不同
3. **网络超时设置**：安卓设备可能需要更长的网络超时时间

**修复方案：**

#### 1. 前端修复 (`frontend/utils/request.js`)
- **增强用户标识获取逻辑**：支持从全局状态和本地存储双重获取
- **多种请求头格式**：同时发送`X-User-Openid`、`x-user-openid`、`openid`等多种格式
- **安卓设备检测**：自动检测安卓设备并启用特殊处理逻辑
- **延迟重试机制**：安卓设备在获取用户信息失败时自动延迟重试
- **401错误自动处理**：检测到认证失败时自动清理状态并提示重新登录

#### 2. 数据保存增强 (`frontend/utils/auth.js`)
- **异步存储优先**：使用`wx.setStorage`异步方式确保数据保存可靠性
- **同步存储备选**：异步失败时自动降级到同步存储
- **保存验证机制**：保存后立即验证数据完整性
- **增加超时时间**：安卓设备登录超时时间从10秒增加到15秒

#### 3. 后端认证增强 (`backend/middleware/auth.js`)
- **多格式请求头支持**：兼容各种大小写和格式的请求头
- **详细日志记录**：记录设备信息和认证过程，便于问题诊断
- **自动用户创建**：用户不存在时自动创建，减少认证失败

#### 4. 设备特殊处理 (`frontend/app.js`)
- **设备信息记录**：详细记录设备平台、系统版本等信息
- **安卓验证机制**：安卓设备登录后额外验证登录状态
- **重启建议**：检测到状态异常时建议用户重启小程序

**测试验证：**
- ✅ iOS设备：登录正常，无影响
- ✅ 安卓设备：登录成功率显著提升
- ✅ 网络异常：自动重试和错误处理

### 🐛 问题8：用户首次登录连续弹窗问题 (已修复)

**问题描述：**
用户首次登录时会出现三个连续的弹窗错误：
1. 401错误，缺少用户身份信息
2. 登录状态已失效，请重新登录
3. `.r.perfornWechatLogin is not a function` 错误

**根本原因分析：**
1. **函数导出错误**：`auth.js` 中的 `performWechatLogin` 函数是独立函数，未正确添加到 `WechatAuth` 类中
2. **重复错误处理**：`request.js` 中的 `handleAuthError` 方法会重复触发，导致多个弹窗同时出现
3. **缺乏智能登录**：没有检查现有登录状态的机制，总是执行完整的登录流程

**修复方案：**

#### 1. 修复函数导出 (`frontend/utils/auth.js`)
- **移动函数到类中**：将 `performWechatLogin` 函数移动到 `WechatAuth` 类中作为静态方法
- **新增智能登录**：添加 `smartLogin` 方法，先检查现有登录状态，避免不必要的重新登录
- **统一模块导出**：确保所有登录相关方法都通过 `WechatAuth` 类统一导出

#### 2. 优化错误处理 (`frontend/utils/request.js`)
- **防重复处理**：添加 `isHandlingAuthError` 标志，防止同时处理多个认证错误
- **静默重新登录**：实现 `silentReLogin` 方法，在401错误时自动静默重新登录
- **减少弹窗**：只有在静默登录失败时才显示用户提示，避免连续弹窗

#### 3. 统一登录入口 (`frontend/app.js` 和页面文件)
- **使用智能登录**：在 `app.js` 和页面中统一使用 `WechatAuth.smartLogin()` 方法
- **避免重复登录**：智能登录会先检查现有状态，避免重复的登录流程
- **优化用户体验**：减少不必要的登录提示和等待时间

#### 4. 增强错误处理机制
- **Context上下文理解**：在每次处理登录问题时，充分理解当前的业务背景和用户状态
- **分步解决**：将复杂的登录问题拆分为多个小步骤，逐步解决
- **任务拆分**：将登录流程拆分为状态检查、微信授权、服务器验证等独立模块

**技术改进：**
- 使用 Context7 最佳实践指导微信小程序登录流程设计
- 实现防重复处理机制，避免并发登录请求
- 添加智能状态检查，减少不必要的网络请求
- 优化错误提示文案，提供更友好的用户体验

**修复时间**: 2025-01-03
**状态**: ✅ 已修复，用户首次登录流程顺畅，无连续弹窗问题

#### 5. 进一步优化页面初始化流程
- **等待应用登录**：页面初始化时等待应用级登录完成，避免过早发起API请求
- **智能数据加载**：确保用户已登录后再获取会议室列表，避免401错误
- **并行数据获取**：用户角色检查和会议室列表获取并行执行，提升加载速度
- **友好错误处理**：初始化失败时提供重试选项，提升用户体验
- ✅ 状态恢复：登录状态丢失时自动重新登录

**部署状态：**
- ✅ 代码已提交到Git仓库
- ✅ 服务器已部署最新版本
- ✅ API服务正常运行 (端口3001)
- ✅ Nginx代理配置已更新

---

## 🚀 功能特性

## 最新更新

### 2024-12-19 预约功能优化与修复
- **周末限制**：前端直接限制周末日期选择，用户选择周末时会提示"周末不可预约，请选择工作日"
- **时间段设置**：
  - 上午时段：08:30-12:00（每30分钟一个时间段）
  - 下午时段：14:30-17:30（每30分钟一个时间段）
- **界面优化**：
  - 将时间段分为"上午时段"和"下午时段"两个区域
  - 每个区域显示准确的时间范围说明
  - 添加分隔线和标题，提供更清晰的视觉层次
  - 会议室描述支持换行显示，提升可读性
- **逻辑优化**：更新午休时间跨越验证逻辑，正确处理12:00-14:30的午休时间

### 2024-12-19 Android登录问题修复
