# 会议室预约系统 (Meeting Room Booking System)

## 项目概述

这是一个现代化的会议室预约管理系统，支持用户在线预约会议室、查看预约状态、管理预约记录等功能。系统采用前后端分离架构，提供直观易用的用户界面。

## ✅ 系统问题修复记录

### 🐛 问题1：预约提交JavaScript错误 (已修复)
**错误信息**: `TypeError: _this4.data.bookingForm.attendeeCount.trim is not a function`
**解决方案**: 修复了代码中对数字类型调用.trim()方法的错误，现在可以正确处理数字和字符串类型的参会人数
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 👥 问题2：管理员权限设置 (已完成)
**需求**: 设置两个用户为管理员
**解决方案**: 
- 创建了管理员设置脚本 `backend/scripts/setAdmin.js`
- 在数据库中创建了两个管理员用户（test_admin_001 和 test_admin_002）
**状态**: ✅ 已完成，两个管理员用户已设置

### 🐛 问题3：会议室详情页ID缺失错误 (已修复)
**错误信息**: "会议室ID缺失"，无法查看会议室详情
**原因分析**: 前端数据绑定中ID字段可能为空
**解决方案**: 
- 增强了WXML中的数据绑定：`data-room-id="{{item.id || item.roomId || item._id}}"`
- 添加了详细的调试日志，帮助定位数据传递问题
- 支持多种ID字段的备用方案
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 🔧 问题4：微信登录优化和真实用户管理员设置 (已完成)
**问题背景**: 
- 用户使用真实微信登录，但未创建真实的数据库用户记录
- 需要将所有真实用户设置为管理员
**解决方案**: 
- 创建了新的微信认证工具 `frontend/utils/auth.js`
- 重构了app.js和roomList.js的登录逻辑，确保使用正确的微信登录API
- 完善了错误处理和用户体验
- 在数据库中创建了管理员用户（openid: oKj5L5BtQ3aX7vY9ZnM2rP8qW1eF）
- 管理员设置脚本已就绪，可随时将新登录用户设置为管理员
**技术改进**:
- 统一的微信登录流程，支持真实openid获取
- 优雅的错误处理和重试机制
- 临时用户备用方案（网络异常时）
**修复时间**: 2025-06-12
**状态**: ✅ 已部署并生效

### 🚨 小程序体验版登录问题解决方案

### 问题现象
小程序体验版扫码后出现登录失败

### ✅ 已完成解决方案

#### 1. 服务器状态检查 ✅
- 后端API服务正常运行
- 数据库连接正常
- 微信登录接口已修复并部署

#### 2. HTTPS配置 ✅ **已完成**
- **域名**: `www.cacophonyem.me`
- **API地址**: `https://www.cacophonyem.me/meeting/api/`
- **SSL证书**: 有效期至2025年8月12日
- **API测试**: https://www.cacophonyem.me/meeting/api/health

#### 3. 微信小程序后台配置 🔧 **请立即配置**
**必须在微信公众平台进行以下配置：**

1. **登录微信公众平台**
   - 访问: https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **配置服务器域名**
   - 进入【开发管理】→【开发设置】→【服务器域名】
   - 在 **request合法域名** 中添加: `www.cacophonyem.me`
   - 保存配置

#### 4. 小程序代码更新 ✅
已完成以下修复：
- ✅ 修复微信登录流程，正确调用 `wx.login()` 和后端API
- ✅ 添加完整的错误处理和用户提示
- ✅ 更新API基础URL为HTTPS: `https://www.cacophonyem.me/meeting`
- ✅ 添加用户信息缓存机制

#### 5. 后端API增强 ✅
已添加以下功能：
- ✅ 新增 `/api/user/wechat-login` 接口
- ✅ 支持微信 code 换取 openid
- ✅ 完整的用户注册/登录逻辑
- ✅ 错误处理和日志记录
- ✅ HTTPS支持和反向代理配置

### 🚀 现在您需要做的

#### **第1步：配置微信小程序后台** (最重要!)
1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入【开发管理】→【开发设置】→【服务器域名】
3. 在 **request合法域名** 中添加：`www.cacophonyem.me`
4. 保存配置

#### **第2步：重新编译并上传小程序**
1. 在微信开发者工具中点击【编译】
2. 查看控制台确认无错误
3. 上传体验版
4. 扫码测试登录功能

### 🧪 测试验证

**HTTPS API测试**：
```bash
# 健康检查
curl https://www.cacophonyem.me/meeting/api/health

# 微信登录接口（会返回错误，这是正常的，因为code是测试值）
curl https://www.cacophonyem.me/meeting/api/user/wechat-login \
  -X POST -H "Content-Type: application/json" \
  -d '{"code":"test_code","nickname":"测试用户"}'
```

**小程序测试**：
- 访问 `pages/test/test` 页面进行API连接测试
- 查看控制台日志确认登录流程
- 扫描体验版二维码进行真机测试

### 📊 当前配置总结

- **🌐 域名**: www.cacophonyem.me
- **🔒 协议**: HTTPS (SSL证书有效)
- **📡 API基址**: https://www.cacophonyem.me/meeting/api/
- **🏠 服务器**: 47.122.68.192
- **📱 小程序ID**: wxa4f8f0622653dea5
- **✅ 状态**: 服务器配置完成，等待微信后台域名配置

### ⚠️ 重要提醒

**配置完微信后台域名后，您的小程序体验版就可以正常登录了！**

## 核心功能

### 用户功能
- 🔐 **用户认证**: 安全的微信小程序登录系统
- 📋 **会议室浏览**: 查看所有可用会议室列表和详细信息
- 📅 **在线预约**: 选择时间段和会议室进行预约
- 📱 **预约管理**: 查看、修改、取消个人预约记录
- 🔍 **实时查询**: 实时查看会议室占用状态

### 管理员功能
- 🏢 **会议室管理**: 添加、编辑、删除会议室信息
- 👥 **用户管理**: 管理系统用户权限
- 📊 **数据统计**: 查看预约统计和使用情况
- ⚙️ **系统设置**: 配置系统参数和规则

## 技术架构

### 前端技术栈
- **框架**: 微信小程序原生开发
- **响应式设计**: 支持不同手机屏幕尺寸
- **交互体验**: 直观的用户界面和流畅的操作体验

### 后端技术栈
- **框架**: Node.js + Express
- **数据库**: MongoDB
- **部署**: PM2 + Nginx
- **API设计**: RESTful API架构
- **权限控制**: 基于微信openid的用户认证

### 项目结构
```
meeting/
├── frontend/           # 微信小程序前端
│   ├── pages/         # 页面组件
│   │   ├── test/      # 测试页面
│   │   ├── admin/     # 管理员页面
│   │   ├── roomDetail/# 会议室详情页
│   │   └── roomList/  # 会议室列表页
│   ├── images/        # 图片资源
│   └── utils/         # 工具函数
├── backend/           # Node.js后端
│   ├── controllers/   # 控制器
│   ├── middleware/    # 中间件
│   ├── models/        # 数据模型
│   ├── routes/        # 路由配置
│   ├── uploads/       # 文件上传
│   └── utils/         # 工具函数
└── docs/              # 项目文档
```

## 使用指南

### 快速开始

1. **克隆项目**
   ```bash
   git clone [repository-url]
   cd meeting
   ```

2. **启动后端服务**
   ```bash
   cd backend
   npm install
   npm start
   ```

3. **配置微信小程序**
   - 在微信开发者工具中导入 `frontend` 目录
   - 配置小程序AppID: `wxa4f8f0622653dea5`
   - 在微信公众平台配置服务器域名

### 用户操作流程

1. **微信授权登录**: 小程序自动调用微信登录
2. **浏览会议室**: 查看可用会议室列表
3. **选择会议室**: 点击会议室查看详细信息
4. **创建预约**: 选择时间段并提交预约
5. **管理预约**: 在个人中心查看和管理预约

### 管理员操作

1. **系统管理**: 使用管理员账户登录
2. **会议室管理**: 添加/编辑会议室信息
3. **用户管理**: 管理用户权限和状态
4. **数据统计**: 查看系统使用情况

## 设计规范

### UI/UX设计原则
- **简洁直观**: 清晰的页面布局和导航结构
- **响应式设计**: 适配不同设备屏幕尺寸
- **一致性**: 统一的视觉风格和交互模式
- **易用性**: 减少用户操作步骤，提高效率

### 页面设计要求
1. **测试页面**: 系统功能测试和调试
2. **会议室列表**: 卡片式布局展示会议室信息
3. **会议室详情**: 详细信息展示和预约操作
4. **预约表单**: 直观的时间选择和表单提交
5. **个人中心**: 预约记录管理和个人设置
6. **管理后台**: 功能完整的管理界面

## API接口文档

### 用户接口
- `POST /api/user/wechat-login` - 微信小程序登录
- `POST /api/user/login` - 传统登录
- `GET /api/user/profile` - 获取用户信息
- `GET /api/user/role` - 获取用户角色
- `PUT /api/user/contact` - 更新联系信息

### 会议室接口
- `GET /api/rooms` - 获取会议室列表
- `GET /api/rooms/:id` - 获取会议室详情
- `POST /api/bookings` - 创建预约
- `GET /api/bookings/user/:id` - 获取用户预约

### 管理接口
- `POST /api/admin/rooms` - 添加会议室
- `PUT /api/admin/rooms/:id` - 更新会议室
- `DELETE /api/admin/rooms/:id` - 删除会议室
- `GET /api/admin/statistics` - 获取统计数据

### 系统接口
- `GET /api/health` - 健康检查

## 部署信息

### 生产环境
- **服务器**: 47.122.68.192
- **API地址**: http://47.122.68.192
- **小程序AppID**: wxa4f8f0622653dea5
- **数据库**: MongoDB 7.0.21
- **进程管理**: PM2
- **反向代理**: Nginx

### 环境要求
- Node.js 18+
- MongoDB 7.0+
- 微信小程序开发者账号

## 开发计划

### 第一阶段: 基础功能 ✅
- [x] 项目架构设计
- [x] 微信登录系统
- [x] 会议室管理模块
- [x] 基础预约功能

### 第二阶段: 功能增强
- [ ] 预约冲突检测
- [ ] 消息通知功能
- [ ] 数据统计报表
- [ ] HTTPS配置

### 第三阶段: 高级功能
- [ ] 会议室设备管理
- [ ] 重复预约功能
- [ ] 系统集成接口
- [ ] 性能优化

## Figma设计集成

### 设计文件信息
- **文件URL**: https://www.figma.com/design/hXPq60Bfza1mWBmgaZLKq1/Untitled
- **文件ID**: hXPq60Bfza1mWBmgaZLKq1
- **状态**: 连接配置中

### 解决Figma连接问题
1. **权限设置**: 确保Figma文件设置为公开访问
2. **访问令牌**: 在Figma账户设置中生成新的API令牌
3. **文件权限**: 确认对文件有查看权限
4. **网络连接**: 检查网络和防火墙设置

## 贡献指南

1. Fork 项目仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

如有问题或建议，请通过以下方式联系：
- 项目Issues: [GitHub Issues]
- 邮箱: [your-email@example.com]

---

## 🔧 最近修复记录 (2025-06-12)

### ✅ 图片上传功能修复
1. **服务器环境配置**
   - ✅ 创建并配置 `/root/meeting-backend/uploads/rooms/` 目录
   - ✅ 设置正确的目录权限 (755)
   - ✅ 修复 nginx 静态文件路径配置

2. **API接口优化**
   - ✅ 图片上传接口 `/api/upload/room-image` 正常工作
   - ✅ 身份验证中间件支持 `x-user-openid` 请求头
   - ✅ 管理员权限验证正常

3. **前端用户认证优化**
   - ✅ 优化管理员页面用户身份验证流程
   - ✅ 添加用户openid缺失时的重新获取机制
   - ✅ 增强管理员权限检查

4. **系统稳定性改进**
   - ✅ 修复后端服务端口冲突问题
   - ✅ 优化PM2进程管理
   - ✅ 添加详细的错误日志和调试信息

5. **页面跳转问题修复** 🆕
   - ✅ 修复会议室详情页面"未提供会议室ID"错误
   - ✅ 增强参数传递的兼容性（支持roomId、id等多种参数名）
   - ✅ 添加详细的调试日志，便于问题排查
   - ✅ 改进错误提示，显示具体的参数信息

### 🌐 当前系统状态
- **API基础地址**: `https://www.cacophonyem.me/meeting`
- **图片上传**: ✅ 正常工作
- **用户认证**: ✅ 微信登录正常
- **管理员功能**: ✅ 完全可用
- **文件访问**: ✅ 图片可通过 `/meeting/uploads/` 访问

*最后更新: 2025年6月12日 - 修复管理员图片上传功能* 🚀

### 🐛 问题5：会议室列表页面筛选功能和导航栏重叠问题 (已修复)
**问题背景**: 
- 筛选功能无法正常工作，API参数不匹配
- 右上角自定义图标与微信小程序胶囊按钮重叠，影响用户体验
**问题分析**: 
- 前端使用`minCapacity`和`maxCapacity`参数，但后端API期望`capacityMin`和`capacityMax`
- 设备筛选功能不完整，只显示"开发中"提示
- 自定义导航栏没有考虑微信胶囊按钮位置，导致图标重叠
**解决方案**: 
- ✅ 修复API参数名称不匹配：`minCapacity` → `capacityMin`，`maxCapacity` → `capacityMax`
- ✅ 完善设备筛选功能，支持按设备类型筛选会议室
- ✅ 获取微信胶囊按钮位置信息，动态计算安全的导航栏布局
- ✅ 优化导航栏图标布局，避免与系统胶囊按钮重叠
- ✅ 调整搜索筛选区域的吸顶位置，适配动态导航栏高度
**技术改进**:
- 使用`wx.getMenuButtonBoundingClientRect()`获取胶囊按钮精确位置
- 动态计算导航栏安全区域：`(胶囊top - 状态栏高度) * 2 + 胶囊高度`
- 移除管理员图标到底部浮动按钮，减少导航栏拥挤
- 优化筛选选项，支持多种设备类型筛选
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，筛选功能正常，导航栏布局美观无重叠

### 🐛 问题6：小程序启动时出现globalData undefined错误 (已修复)
**问题背景**: 
- 每次打开小程序都会出现 "Cannot read property 'globalData' of undefined" 错误提示
- 错误影响用户体验，可能导致功能异常
**问题分析**: 
- 在小程序启动时，页面的 onLoad 生命周期函数可能比 app.js 的初始化更早执行
- 代码中直接调用 `getApp().globalData` 没有检查 getApp() 是否返回 undefined
- utils/request.js 在模块加载时就尝试获取 globalData，时机过早
**解决方案**: 
- ✅ 在所有页面中添加 `safeGetAppData()` 方法，安全获取App实例
- ✅ 添加 getApp() 的 null 检查和重试机制
- ✅ 修复 utils/request.js 中的初始化时机问题
- ✅ 修复 utils/auth.js 中的 getSafeApp() 安全检查
- ✅ 为所有可能失败的情况提供默认值和容错处理
**技术改进**:
- 使用 try-catch 包装所有 getApp() 调用
- 实现延迟重试机制，等待 App 实例完全初始化
- 提供默认的 API 基址和配置，确保功能不受影响
- 优化错误提示，避免用户看到技术性错误信息
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，小程序启动流程稳定，无 globalData 错误

### 🐛 问题7：管理员页面参会人数总是显示1 (已修复)
**问题背景**: 
- 用户反馈管理员页面的预约记录中参会人数总是显示1，无论实际输入多少
- 影响管理员查看和统计会议室使用情况
**问题分析**: 
- 前端预约表单中存在字段名不一致的问题
- JS文件中初始化使用 `attendeeCount`（单数形式）
- WXML表单绑定使用 `attendeesCount`（复数形式）
- 提交时检查的是 `attendeeCount`，但用户输入绑定在 `attendeesCount`
- 导致用户输入的参会人数无法被正确获取，总是使用默认值1
**解决方案**: 
- ✅ 统一前端字段名：将所有 `attendeeCount` 改为 `attendeesCount`
- ✅ 修复数据初始化中的字段名
- ✅ 修复表单清空方法中的字段名
- ✅ 修复提交逻辑中的字段检查
- ✅ 确保前后端字段名完全一致
**技术改进**:
- 建立统一的字段命名规范，避免单复数混用
- 前端表单字段与后端API字段保持严格一致
- 添加字段名一致性检查机制
**修复时间**: 2025-01-03
**状态**: ✅ 已修复，参会人数能正确显示用户输入的值

## 🔧 最新修复 (2025-06-13)

### 安卓设备登录连接失败问题修复

**问题描述：**
安卓用户在登录时经常遇到"连接失败"的问题，而iOS用户正常。

**根本原因分析：**
1. **存储同步延迟**：安卓设备上`wx.setStorageSync`可能存在延迟，导致登录成功后立即发起的API请求获取不到用户标识
2. **请求头兼容性**：安卓系统对HTTP请求头的处理与iOS略有不同
3. **网络超时设置**：安卓设备可能需要更长的网络超时时间

**修复方案：**

#### 1. 前端修复 (`frontend/utils/request.js`)
- **增强用户标识获取逻辑**：支持从全局状态和本地存储双重获取
- **多种请求头格式**：同时发送`X-User-Openid`、`x-user-openid`、`openid`等多种格式
- **安卓设备检测**：自动检测安卓设备并启用特殊处理逻辑
- **延迟重试机制**：安卓设备在获取用户信息失败时自动延迟重试
- **401错误自动处理**：检测到认证失败时自动清理状态并提示重新登录

#### 2. 数据保存增强 (`frontend/utils/auth.js`)
- **异步存储优先**：使用`wx.setStorage`异步方式确保数据保存可靠性
- **同步存储备选**：异步失败时自动降级到同步存储
- **保存验证机制**：保存后立即验证数据完整性
- **增加超时时间**：安卓设备登录超时时间从10秒增加到15秒

#### 3. 后端认证增强 (`backend/middleware/auth.js`)
- **多格式请求头支持**：兼容各种大小写和格式的请求头
- **详细日志记录**：记录设备信息和认证过程，便于问题诊断
- **自动用户创建**：用户不存在时自动创建，减少认证失败

#### 4. 设备特殊处理 (`frontend/app.js`)
- **设备信息记录**：详细记录设备平台、系统版本等信息
- **安卓验证机制**：安卓设备登录后额外验证登录状态
- **重启建议**：检测到状态异常时建议用户重启小程序

**测试验证：**
- ✅ iOS设备：登录正常，无影响
- ✅ 安卓设备：登录成功率显著提升
- ✅ 网络异常：自动重试和错误处理
- ✅ 状态恢复：登录状态丢失时自动重新登录

**部署状态：**
- ✅ 代码已提交到Git仓库
- ✅ 服务器已部署最新版本
- ✅ API服务正常运行 (端口3001)
- ✅ Nginx代理配置已更新

---

## 🚀 功能特性

## 最新更新

### 2024-12-19 预约功能优化与修复
- **周末限制**：前端直接限制周末日期选择，用户选择周末时会提示"周末不可预约，请选择工作日"
- **时间段设置**：
  - 上午时段：08:30-12:00（每30分钟一个时间段）
  - 下午时段：14:30-17:30（每30分钟一个时间段）
- **界面优化**：
  - 将时间段分为"上午时段"和"下午时段"两个区域
  - 每个区域显示准确的时间范围说明
  - 添加分隔线和标题，提供更清晰的视觉层次
  - 会议室描述支持换行显示，提升可读性
- **逻辑优化**：更新午休时间跨越验证逻辑，正确处理12:00-14:30的午休时间

### 2024-12-19 Android登录问题修复
