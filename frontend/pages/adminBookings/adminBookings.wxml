<view class="page">
  <view class="floating-back" style="top: {{statusBarHeight + 6}}px;" bindtap="goBack">
    <image class="nav-back" src="/images/icons/back.png" mode="aspectFit"></image>
  </view>

  <scroll-view class="content" scroll-y bindscrolltolower="loadMoreBookings" style="padding-top: {{statusBarHeight + 40}}px;">
    <view class="toolbar">
      <text class="stats-text">预约记录</text>
      <view class="btn ghost" bindtap="exportBookings" wx:if="{{!exporting}}">导出Excel</view>
      <view class="btn ghost" wx:if="{{exporting}}">导出中...</view>
    </view>

    <view class="stats-dash">
      <view class="stat-cell {{filterStatus==='all'?'active':''}}" data-status="all" bindtap="onFilterChange">
        <text class="stat-num">{{stats.total}}</text>
        <text class="stat-label">全部</text>
      </view>
      <view class="stat-cell {{filterStatus==='active'?'active':''}}" data-status="active" bindtap="onFilterChange">
        <text class="stat-num">{{stats.active}}</text>
        <text class="stat-label">进行中/已预约</text>
      </view>
      <view class="stat-cell {{filterStatus==='completed'?'active':''}}" data-status="completed" bindtap="onFilterChange">
        <text class="stat-num">{{stats.completed}}</text>
        <text class="stat-label">已完成</text>
      </view>
      <view class="stat-cell {{filterStatus==='cancelled'?'active':''}}" data-status="cancelled" bindtap="onFilterChange">
        <text class="stat-num">{{stats.cancelled}}</text>
        <text class="stat-label">已取消</text>
      </view>
    </view>

    <view wx:if="{{bookingsLoading}}" class="loading-more"><view class="mini-spinner"></view><text class="loading-more-text">加载中...</text></view>
    <view wx:elif="{{!bookingsLoading && filteredBookings.length === 0}}" class="empty">
      <image class="empty-icon" src="/images/icons/empty.png"/>
      <text class="empty-title">暂无预约记录</text>
    </view>
      <view wx:else class="b-cards">
      <view wx:for="{{filteredBookings}}" wx:key="uniqueKey" class="b-card">
        <view class="b-top">
          <view class="b-meta">
            <text class="b-room">{{item.conferenceRoomName}}</text>
            <text class="b-loc" wx:if="{{item.roomLocation}}">{{item.roomLocation}}</text>
          </view>
          <view class="b-chip {{item.displayStatusClass}}">{{item.displayStatus}}</view>
        </view>
        <view class="b-time">
          <text class="b-date">{{item.bookingDate}}</text>
          <text class="b-range">{{item.startTime}} - {{item.endTime}}</text>
        </view>
        <view class="b-detail">
          <text wx:if="{{item.topic}}" class="b-text">主题：{{item.topic}}</text>
          <text wx:if="{{item.attendeesCount}}" class="b-text">参会：{{item.attendeesCount}}人</text>
          <text class="b-text">联系人：{{item.userName}} {{item.userPhone}}</text>
          <text wx:if="{{item.userCompany}}" class="b-text">公司：{{item.userCompany}}</text>
          <text wx:if="{{item.userDepartment}}" class="b-text">部门：{{item.userDepartment}}</text>
        </view>
        <view class="b-actions" wx:if="{{item.canCancel}}">
          <button class="mini danger" data-id="{{item.id}}" catchtap="adminCancelBooking">取消预约</button>
        </view>
      </view>
      <view wx:if="{{bookingsHasMore && filteredBookings.length}}" class="loading-more" bindtap="loadMoreBookings">
        <view wx:if="{{bookingsLoading}}" class="mini-spinner"></view>
        <text class="loading-more-text">{{bookingsLoading ? '加载中...' : '点击加载更多'}}</text>
      </view>
      <view class="bottom-space"></view>
    </view>
  </scroll-view>
</view>
