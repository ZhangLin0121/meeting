# 三端同步方案 - 本地、Git仓库、服务器

## 🎯 目标
确保本地开发环境、Git远程仓库、生产服务器三端代码完全同步，且所有功能正常工作。

## 📊 当前状态

### ✅ 本地环境 (已完成)
- **代码状态**: 最新，包含所有修复
- **主要更新**:
  - 修复了设备配置点选无效问题
  - 重构了项目结构，整理了文档和脚本
  - 删除了重复和冗余文件
- **提交状态**: 已提交到本地Git仓库
- **测试状态**: 功能修复已完成

### ⏳ Git远程仓库 (待同步)
- **状态**: 由于网络问题暂时无法推送
- **差距**: 本地领先2个提交
  1. `7d63dce` - 修复设备配置点选无效问题
  2. `7138913` - 重构项目结构和整理文档
- **需要操作**: 网络恢复后推送

### ⏳ 生产服务器 (待同步)
- **状态**: 使用旧版本代码
- **差距**: 缺少最新的修复和优化
- **需要操作**: 从Git拉取最新代码并重启服务

## 🚀 同步执行计划

### 第一阶段：推送到Git仓库
```bash
# 当网络恢复后执行
git push origin main

# 验证推送成功
git log --oneline -5
```

### 第二阶段：服务器同步
```bash
# 连接服务器
ssh root@47.122.68.192

# 进入项目目录
cd /root/meeting-backend

# 备份当前版本（可选）
cp -r . ../meeting-backend-backup-$(date +%Y%m%d_%H%M%S)

# 拉取最新代码
git pull origin main

# 安装依赖（如有新增）
npm install

# 重启服务
pm2 restart meeting-backend

# 检查服务状态
pm2 status
pm2 logs meeting-backend --lines 20
```

## 🧪 功能验证清单

### 1. API服务验证
```bash
# 健康检查
curl https://www.cacophonyem.me/meeting/api/health

# 用户登录测试
curl -X POST https://www.cacophonyem.me/meeting/api/user/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code"}'

# 会议室列表
curl https://www.cacophonyem.me/meeting/api/rooms \
  -H "x-user-openid: test_openid"
```

### 2. 前端功能验证
#### 普通用户功能
- [ ] 打开小程序，查看会议室列表
- [ ] 点击会议室进入详情页
- [ ] 测试时间段选择功能
- [ ] 测试预约提交功能
- [ ] 验证实时缓存功能
- [ ] 测试个人信息自动填充

#### 管理员功能  
- [ ] 访问管理员页面
- [ ] **重点测试：设备配置功能**
  - 点击添加会议室
  - 测试设备选项点击响应
  - 验证选中状态正确显示
  - 测试多选功能
  - 保存并验证设备信息
- [ ] 测试会议室编辑功能
- [ ] 测试图片上传功能
- [ ] 验证预约记录管理

### 3. 性能验证
- [ ] 页面加载速度
- [ ] 图片显示正常
- [ ] 网络请求响应时间
- [ ] 内存使用情况

## 📋 执行脚本

### 自动化同步脚本
```bash
#!/bin/bash
# 使用现有的 deploy.sh 脚本

./deploy.sh
```

### 手动同步步骤
```bash
# 1. 推送代码
git push origin main

# 2. 服务器部署
ssh root@47.122.68.192 << 'EOF'
cd /root/meeting-backend
git pull origin main
npm install
pm2 restart meeting-backend
pm2 status
echo "✅ 部署完成"
EOF

# 3. 验证服务
curl https://www.cacophonyem.me/meeting/api/health
```

## 🚨 风险控制

### 回滚方案
如果部署后发现问题：
```bash
# 服务器端回滚
cd /root/meeting-backend
git log --oneline -10
git reset --hard <previous_commit_hash>
pm2 restart meeting-backend
```

### 备份策略
- 部署前自动备份数据库
- 保留服务器代码备份
- 记录重要配置文件

## 📝 验证检查表

### 网络层
- [ ] API服务正常响应
- [ ] HTTPS证书有效
- [ ] 域名解析正确

### 应用层
- [ ] 用户登录功能正常
- [ ] 会议室数据正确显示
- [ ] 预约功能完整可用
- [ ] 管理员功能正常
- [ ] **设备配置修复生效**

### 数据层
- [ ] 数据库连接正常
- [ ] 数据读写功能正常
- [ ] 图片上传和显示正常

## 🔧 故障排除

### 常见问题
1. **网络连接问题**
   - 检查服务器网络状态
   - 验证域名DNS解析
   - 确认防火墙设置

2. **代码同步问题**
   - 确认Git仓库权限
   - 检查分支状态
   - 验证提交历史

3. **服务启动问题**
   - 查看PM2日志
   - 检查端口占用
   - 验证环境变量

### 调试命令
```bash
# 服务器状态
pm2 status
pm2 logs meeting-backend --lines 50

# 系统资源
top
df -h
netstat -tlnp | grep 3000

# 应用日志
tail -f /root/meeting-backend/logs/app.log
```

## 🎉 完成标志

当以下条件全部满足时，三端同步完成：

1. ✅ 本地Git仓库干净（无未提交变更）
2. ✅ 远程仓库包含最新提交
3. ✅ 服务器代码与Git仓库一致
4. ✅ 所有API服务正常响应
5. ✅ 前端功能全部正常
6. ✅ **设备配置修复功能验证通过**
7. ✅ 性能指标在正常范围内

---

**执行时间预估**: 15-30分钟  
**主要风险**: 网络连接问题、服务重启期间的短暂中断  
**备份策略**: 已就绪，可快速回滚 